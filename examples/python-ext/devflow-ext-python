#!/usr/bin/env python3
import sys
import json

def handle_discover():
    # Return a JSON array of supported capabilities.
    # We will declare support for "test" and "fmt" for demonstration.
    capabilities = ["test", "fmt", "test:lint"]
    print(json.dumps(capabilities))
    sys.exit(0)

def handle_build_action():
    # Read CommandRef from stdin as JSON
    try:
        input_data = sys.stdin.read()
        cmd_ref = json.loads(input_data)
    except Exception as e:
        print(f"Error reading JSON from stdin: {e}", file=sys.stderr)
        sys.exit(1)
        
    primary = cmd_ref.get("primary")
    selector = cmd_ref.get("selector")
    
    # Based on the command reference, return an ExecutionAction
    # Returning {"program": "...", "args": ["..."]}
    if primary == "test":
        if selector == "lint":
            action = {"program": "flake8", "args": ["."]}
        else:
            action = {"program": "pytest", "args": ["tests/"]}
    elif primary == "fmt":
        action = {"program": "black", "args": ["."]}
    else:
        # Fallback empty action or decline
        print("Unsupported command", file=sys.stderr)
        sys.exit(1)
        
    print(json.dumps(action))
    sys.exit(0)

def main():
    if "--discover" in sys.argv:
        handle_discover()
    elif "--build-action" in sys.argv:
        handle_build_action()
    else:
        print("Usage: devflow-ext-python [--discover | --build-action]", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()
